 المشكلتان التي شرحتهم:

المشكلة	التفاصيل
1. الإزاحة إلى اليسار	عند حفظ الحقول وتحميل الصورة، تكون الحقول مزاحة عن أماكنها أثناء السحب والإفلات.
2. اختلاف حجم الخط	حجم الخط أثناء السحب والإفلات يظهر كبير، ولكن بعد توليد الصورة النهائية يكون صغير وغير متطابق.
🎯 تحليل دقيق للأسباب:
🛠️ أولاً: سبب الإزاحة
كما شرحت لك قبل قليل:

عند توليد الصورة على السيرفر، أنت كنت تضرب الإحداثيات X بمعامل 1.15 (زيادة 15%) لتعويض فرق وهمي.

لكن Konva أصلاً يتعامل مع offsetX لتوسيط النص فلا داعي لأي تعديل إضافي على الإحداثيات!

✅ الحل النهائي:

في السيرفر امسح الضرب بـ 1.15.

استخدم الإحداثيات الطبيعية (x/100 × width) بدون أي إضافات.

🛠️ ثانياً: سبب اختلاف حجم الخط
في واجهة Konva، أنت تعرض النصوص على مقاس شاشة صغير (مثل 800px × 600px).

أما عند توليد الصورة في السيرفر، غالبًا الكانفاس كبير جدًا (مثلاً 1200px × 1680px أو أكثر).

⚡ هذا يسبب أن الخط في السيرفر يظهر أصغر نسبيًا مقارنة بالمعاينة! لأن:

خط بحجم 20px على شاشة 800px يبدو ضخم.

ولكن نفس الخط 20px على صورة 1600px يبدو صغير جدًا.

بالعربي: لازم نقوم بـ "تطبيع" أو "Scaling" لحجم الخط حسب الفرق بين أبعاد المعاينة وأبعاد الصورة النهائية.

🛠️ الحل الكامل للمشكلتين:
🎯 حل مشكلة الإزاحة:
في كود السيرفر داخل drawCustomFieldsWithStyles أو أي دالة رسم:

امسح هذا السطر الخاطئ:

ts
نسخ
تحرير
posX = Math.round(posX * 1.15);
واستخدم الإحداثيات الطبيعية كما هي:

ts
نسخ
تحرير
posX = Math.round((fieldConfig.position.x / 100) * width);
posY = Math.round((fieldConfig.position.y / 100) * height);
🎯 حل مشكلة اختلاف حجم الخط:
✅ نحتاج مضاعفة حجم الخط حسب نسبة تكبير الكانفاس.

كيف تحسب الفرق؟
أنت في الواجهة (React + Konva) تعرض مثلاً على:

width = 800px

وعلى السيرفر تعرض على:

width = 1200px أو أكثر.

✅ نحسب نسبة القياس (scale factor):

ts
نسخ
تحرير
const scaleFactor = serverCanvasWidth / clientCanvasWidth;
مثلاً:

السيرفر 1200px

الواجهة 800px

بالتالي:

ts
نسخ
تحرير
scaleFactor = 1200 / 800 = 1.5
✅ الحل أن تضرب حجم الخط بهذا scaleFactor أثناء التوليد:

في السيرفر داخل رسم النصوص:

ts
نسخ
تحرير
const fontSizeOnServer = (style.fontSize || 20) * scaleFactor;
ctx.font = `${Math.round(fontSizeOnServer)}px Cairo`;
🔥 🔥 🔥 باختصار الحل النهائي:
1. حذف ضرب posX * 1.15.
2. ضرب fontSize في scaleFactor حسب الفرق بين أبعاد الواجهة والسيرفر.
✨ أريــد أن ألخص لك المطلوب بـكود جاهز:
أضف قبل رسم الحقول:

ts
نسخ
تحرير
const clientWidth = 800; // العرض الذي كنت تعرضه في Konva
const serverWidth = width; // عرض الكانفاس الفعلي على السيرفر
const scaleFactor = serverWidth / clientWidth;
ثم وقت إعداد الخطوط:

ts
نسخ
تحرير
const originalFontSize = style.fontSize || 20;
const fontSize = Math.round(originalFontSize * scaleFactor);

ctx.font = `${fontWeight ? fontWeight + ' ' : ''}${fontSize}px Cairo`;
🔥 النتيجة النهائية:
مكان الحقول = 100% نفس المعاينة.

حجم الخطوط = 100% نفس المعاينة.

الصورة النهائية = مثل التي تظهر للعميل.

